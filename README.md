# PAI-EAS-Tutorial
ç›®å‰ï¼ŒPAI EASæä¾›çš„åœ¨çº¿é¢„æµ‹æœåŠ¡éƒ¨ç½²æ–¹å¼æœ‰å››ç§ï¼š

- æ§åˆ¶å°ä¸Šä¼ æ¨¡å‹ï¼ˆç½‘é¡µæ“ä½œï¼‰
- PAI Studioä¸€é”®éƒ¨ç½²ï¼ˆéœ€ä½¿ç”¨é˜¿é‡Œäº‘å…¨å®¶æ¡¶ï¼‰
- PAI DSWéƒ¨ç½²ï¼ˆåŒä¸Šï¼‰
- æœ¬åœ°å®¢æˆ·ç«¯éƒ¨ç½²ï¼ˆçº¿ä¸‹ç»ˆç«¯éƒ¨ç½²ï¼‰

äºæ˜¯ï¼Œåœ¨æ²¡æœ‰ä½¿ç”¨`é˜¿é‡Œäº‘å…¨å®¶æ¡¶`çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡"æ§åˆ¶å°ä¸Šä¼ æ¨¡å‹"ã€"æœ¬åœ°å®¢æˆ·ç«¯éƒ¨ç½²"ä¸¤ç§æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚ä¸‹é¢ä»‹ç»ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ¨ç½²çš„ä¼˜ç¼ºç‚¹ï¼š

##### æ§åˆ¶å°ä¸Šä¼ æ¨¡å‹éƒ¨ç½²

- ä¼˜ç‚¹ï¼šEasy to useï¼Œç‚¹å‡ ä¸‹å°±å®Œäº‹ï¼›

![image-20190821102012325](assets/image-20190821102012325.png)

- ç¼ºç‚¹ï¼šæ”¯æŒçš„Processorç§ç±»æœ‰é™åˆ¶ï¼ˆProcessoræ˜¯åŒ…å«åœ¨çº¿é¢„æµ‹é€»è¾‘çš„ç¨‹åºåŒ…ï¼Œé˜¿é‡Œäº‘å·²ç»é’ˆå¯¹å¸¸ç”¨çš„PMMLã€TensorFlowã€Caffeæä¾›å¥½äº†å†…ç½®çš„Processorï¼Œè¿™å‡ ç±»çš„å¸¸è§„æ¨¡å‹éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ‘ä»¬çš„å†…ç½®Processorè¿›è¡ŒæœåŠ¡éƒ¨ç½²ï¼ŒèŠ‚çœå¼€å‘åœ¨çº¿é¢„æµ‹é€»è¾‘çš„æˆæœ¬ã€‚ï¼‰,ä½†æ˜¯è‡ªç”±åº¦ä¸å¤Ÿé«˜ï¼Œå¾€å¾€å¯¹æ¨¡å‹æ ¼å¼ç­‰éƒ½æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œå¹¶ä¸”å¯¹ä½¿ç”¨Pythonè¿›è¡Œæ•°æ®é¢„å¤„ç†ã€åå¤„ç†ä¸å‹å¥½ã€‚

##### æœ¬åœ°å®¢æˆ·ç«¯éƒ¨ç½²

- ä¼˜ç‚¹ï¼šä½¿ç”¨æœ¬åœ°å®¢æˆ·ç«¯é€šè¿‡è‡ªå®šä¹‰Processor PythonSDKçš„æ–¹å¼éƒ¨ç½²åœ¨çº¿é¢„æµ‹æœåŠ¡ï¼Œå¯ä»¥å®ç°ç”¨Python"æƒ³æ€ä¹ˆå†™å°±æ€ä¹ˆå†™"çš„æé«˜è‡ªç”±åº¦æ¨¡å‹æ„å»ºã€é€»è¾‘å¤„ç†ç­‰æ“ä½œï¼›
- ç¼ºç‚¹ï¼šéœ€åœ¨ç»ˆç«¯ä½¿ç”¨`eascmd`è¿›è¡ŒæœåŠ¡ç®¡ç†ï¼ˆåˆ›å»ºæœåŠ¡ï¼Œåˆ é™¤æœåŠ¡ï¼ŒæŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼Œä¿®æ”¹æœåŠ¡ç­‰ï¼‰ã€éƒ¨ç½²ï¼Œæ‰€ä»¥éœ€è¦è®°ä¸€äº›å‘½ä»¤ã€‚ï¼ˆåœ¨GPUæœåŠ¡å™¨å·²å¯¹å®¢æˆ·ç«¯å·¥å…·`eascmd`ä¸‹è½½é…ç½®å®Œæˆï¼Œå¤§å®¶å¯ä»¥é€šè¿‡`eascmd64 --help`æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼‰

##### ä½¿ç”¨`eascmd`éƒ¨ç½²åœ¨çº¿é¢„æµ‹æœåŠ¡ç®€å•ç¤ºä¾‹

é€šè¿‡ä¸Šè¿°ä»‹ç»ï¼Œç›¸ä¿¡å¤§å®¶å¯¹PAI EASæ¨¡å‹åœ¨çº¿æœåŠ¡éƒ¨ç½²éƒ½æœ‰äº†ä¸€å®šçš„äº†è§£ï¼ˆæ§åˆ¶å°éƒ¨ç½²ï¼šç®€å•ä¸è‡ªç”±ã€ç»ˆç«¯éƒ¨ç½²ï¼šè‡ªç”±ä¸ç®€å•ï¼‰ã€‚åšæŒä½¿ç”¨æ§åˆ¶å°éƒ¨ç½²çš„å°ä¼™ä¼´çœ‹åˆ°è¿™å°±å·®ä¸å¤šå•¦ï¼Œç¥æ‚¨ç”Ÿæ´»æ„‰å¿«:)ã€‚æ¥ä¸‹æ¥å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼ˆä½¿ç”¨esimæ¨¡å‹å¯¹ä¸¤å¥è¯è¿›è¡Œç›¸ä¼¼åº¦é¢„æµ‹ï¼‰ï¼Œæ•™ä¼šå¤§å®¶å¦‚ä½•åœ¨ç»ˆç«¯ä½¿ç”¨`eascmd`éƒ¨ç½²è‡ªå·±çš„åœ¨çº¿é¢„æµ‹æœåŠ¡ã€‚

##### Step 0: é…ç½®`eascmd`

ä½¿ç”¨`eascmd`éƒ¨ç½²åœ¨çº¿é¢„æµ‹æœåŠ¡æ—¶ï¼Œéœ€è¦æä¾›è‡ªå·±çš„é˜¿é‡Œäº‘AccessKeyIdå’ŒAccessKeySecretï¼š

```shell
eascmd64 config -i <AccessKeyId> -k <AccessKeySecret> -e pai-eas.cn-hangzhou.aliyuncs.com
```

é€šè¿‡`-e`æŒ‡å®šregionã€‚

##### Step 1: ä½¿ç”¨`eascmd`åˆå§‹åŒ–é¡¹ç›®

å‘½ä»¤ï¼š`eascmd64 pysdk init pai-eas-tutorial/`

è¾“å…¥pythonç‰ˆæœ¬ï¼Œå»ºè®®3.6ï¼›

![image-20190821113039797](assets/image-20190821113039797.png)

è¯¥å‘½ä»¤å®ç°çš„åŠŸèƒ½å¤§è‡´ä¸ºï¼ˆä¸æƒ³çŸ¥é“çš„åŒå­¦ï¼Œå¯è·³è¿‡ï¼‰ï¼šæ–°å»ºåä¸º`pai-eas-tutorial`çš„æ–‡ä»¶å¤¹ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹ä½¿ç”¨`conda`æ–°å»ºåä¸º`ENV`çš„è™šæ‹Ÿç¯å¢ƒï¼ˆæœåŠ¡æ‰€éœ€æ‰€æœ‰ä¾èµ–å‡è£…åœ¨è¯¥è™šæ‹Ÿç¯å¢ƒä¸‹ï¼‰ï¼Œè‡ªåŠ¨å®‰è£…éƒ¨ç½²æ‰€éœ€ç›¸å…³ä¾èµ–ï¼Œlike thisï¼š

![image-20190821113505429](assets/image-20190821113505429.png)

åˆå§‹åŒ–å®Œæˆåï¼Œåœ¨`pai-eas-tutorial`ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°ï¼š

- `app.json`ç”¨äºæè¿°æœåŠ¡éƒ¨ç½²è¿‡ç¨‹ä¸­ç›¸å…³é…ç½®ä¿¡æ¯ï¼›
- `ENV`è™šæ‹Ÿç¯å¢ƒæ–‡ä»¶å¤¹
- `app.py`è¯¥æ–‡ä»¶åœ¨æœåŠ¡æ­£å¼éƒ¨ç½²å‰éœ€è¦è‡ªå·±æ”¹å†™å…¶ä¸­ç›¸å…³ä»£ç ï¼Œç”¨äºæŒ‡å¯¼é¢„æµ‹æœåŠ¡çš„æ­£å¸¸è¿è¡Œï¼ˆä¸»è¦åŒ…æ‹¬æ¨¡å‹åŠ è½½ã€æ•°æ®é¢„å¤„ç†ã€åå¤„ç†é€»è¾‘ï¼‰

##### Step 2: å°†æ¨¡å‹é¢„æµ‹æ‰€éœ€æ–‡ä»¶ç§»è‡³åˆå§‹åŒ–åç›®å½•ï¼Œå¹¶æ”¹å†™`app.py`ï¼ˆç¼–å†™é¢„æµ‹é€»è¾‘ï¼‰

åœ¨éƒ¨ç½²æœåŠ¡ä¹‹å‰ï¼Œç›¸ä¿¡ä½ åº”è¯¥è®­ç»ƒå®Œæˆäº†è‡ªå·±çš„é¢„æµ‹æ¨¡å‹ï¼Œäºæ˜¯ä½ çš„é¡¹ç›®ç›®å½•åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

![image-20190821104742793](assets/image-20190821104742793.png)

- `data`ç›®å½•ä¸‹å­˜æ”¾é¢„æµ‹æœåŠ¡è¿‡ç¨‹ä¸­æ‰€éœ€çš„æ•°æ®æ–‡ä»¶ï¼Œï¼ˆvocab.txtï¼‰
- `models`ç›®å½•ä¸‹å­˜æ”¾æœ‰æ¨¡å‹ç»“æ„ä»£ç ï¼Œä¸€èˆ¬ç”¨äºæ¨¡å‹æ¢å¤ï¼ˆesim.pyï¼‰
- `saved_mdoels`ç›®å½•ä¸‹å­˜æ”¾æœ‰æ¨¡å‹æŒä¹…åŒ–æ–‡ä»¶ï¼ˆesim.h5ï¼‰
- `utils`ç›®å½•ä¸‹å­˜æ”¾æœ‰é¢„æµ‹æœåŠ¡è¿‡ç¨‹ä¸­ï¼Œæ•°æ®å¤„ç†ç­‰ä¸€ç³»åˆ—çç¢çš„ä»£ç ï¼ˆdata_utils.pyï¼‰

å°†ä½ è¦éƒ¨ç½²çš„é¡¹ç›®ç›¸å…³æ–‡ä»¶ç§»è‡³åˆšåˆšåˆå§‹åŒ–çš„åä¸º`pai-eas-tutorial`ç›®å½•ä¸‹ï¼Œäºæ˜¯å½“å‰å®Œæ•´çš„é¡¹ç›®ç»“æ„æ˜¯ï¼š

```shell
.
â”œâ”€â”€ ENV
â”œâ”€â”€ app.json
â”œâ”€â”€ app.py
â”œâ”€â”€ data
â”œâ”€â”€ models
â”œâ”€â”€ saved_models
â””â”€â”€ utils
```

å°†ä½ çš„é¡¹ç›®ç§»åˆ°å¾…éƒ¨ç½²çš„é¡¹ç›®ä¸‹ï¼Œå¹¶ä½¿ç”¨æ–°çš„è™šæ‹Ÿç¯å¢ƒè¿è¡Œï¼Œæƒ³å¿…æœ‰å¾ˆå¤šä¾èµ–éœ€è¦å®‰è£…ã€‚ä»¥æœ¬ä»»åŠ¡ä¸ºä¾‹ï¼Œéœ€è¦å®‰è£…`tensorflow`ã€`keras`ã€`numpy`ã€`pandas`ï¼ˆæ³¨ï¼šç”±äºå½“å‰çº¿ä¸Šæœºå™¨åªæœ‰CPUï¼Œæ‰€ä»¥æ­¤å¤„çš„`tensorflow`ä¸ºCPUç‰ˆæœ¬ï¼ŒGPUç‰ˆæœ¬è¯·å®‰è£…`tensorflow-gpu`ï¼‰ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®‰è£…è¿‡ç¨‹éœ€è¦æŒ‡å®š`ENV`è™šæ‹Ÿç¯å¢ƒçš„`pip`ï¼Œå³ï¼š

```shell
./ENV/bin/pip install tensorflow keras numpy pandas
```

æ¥ä¸‹æ¥å°†æ”¹å†™`app.py`ä¸­çš„ä»£ç ï¼Œé¦–å…ˆé€šè¿‡`eascmd`åˆå§‹åŒ–åçš„`app.py`åŸå§‹ä»£ç å¦‚ä¸‹ï¼š

```python
# -*- coding: utf-8 -*-
import allspark

class MyProcessor(allspark.BaseProcessor):
    """ MyProcessor is a example
        you can send mesage like this to predict
        curl -v http://127.0.0.1:8080/api/predict/service_name -d '2 105'
    """

    def initialize(self):
        """ load module, executed once at the start of the service
         do service intialization and load models in this function.
        """
        self.module = {'w0': 100, 'w1': 2}

    def pre_proccess(self, data):
        """ data format pre process
        """
        x, y = data.split(b' ')
        return int(x), int(y)

    def post_process(self, data):
        """ proccess after process
        """
        return str(data).encode()

    def process(self, data):
        """ process the request data
        """
        x, y = self.pre_proccess(data)

        w0 = self.module['w0']
        w1 = self.module['w1']

        y1 = w1 * x + w0

        if y1 >= y:
            #return str("True"), 0
            return self.post_process("True"), 0
        else:
            return self.post_process("False"), 0

if __name__ == '__main__':
    # paramter worker_threads indicates concurrency of processing
    runner = MyProcessor(worker_threads=10)
    runner.run()
```

è¯¥æ®µä»£ç ä¸­å®ç°äº†åä¸º`MyProcessor`çš„ç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ªåŸºç±»`BaseProcessor`ï¼Œéœ€è¦ä½ è¦†å†™å…¶ä¸­çš„`initialize()`ã€`process()`æ–¹æ³•ã€‚åœ¨æœåŠ¡å¼€å¯æ—¶ï¼Œä¼šè°ƒç”¨ä¸€æ¬¡`initialize()`æ–¹æ³•ï¼Œæ‰€ä»¥ä½ éœ€è¦å°†åŠ è½½æ¨¡å‹åŠä¸€äº›å…¨å±€å˜é‡çš„å®šä¹‰å£°æ˜å†™åœ¨å…¶ä¸­ï¼Œé˜²æ­¢æœåŠ¡è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œé‡å¤åŠ è½½æ¨¡å‹æµªè´¹èµ„æºã€é™ä½æ€§èƒ½ã€‚åœ¨`process()`æ–¹æ³•ä¸­å¯ä»¥å®ç°è‡ªå·±çš„æ¨¡å‹é¢„æµ‹é€»è¾‘ï¼Œä»ä¸Šé¢æºç å¯ä»¥çœ‹è§ï¼Œè¯¥ç±»ä¸­è¿˜å®ç°æœ‰`pre_process()`åŠ`post_process()`æ–¹æ³•ç”¨äºæ¨¡å‹é¢„æµ‹è¿‡ç¨‹ä¸­å¯¹æ•°æ®çš„é¢„å¤„ç†ã€åå¤„ç†ã€‚è¿™äº›æ–¹æ³•å¯ä¾æ®ä½ çš„å…·ä½“æƒ…å†µè¿›è¡Œå®ç°ï¼Œå¯è¦å¯ä¸è¦ï¼Œä¹Ÿå¯ä»¥å¤šè¦ï¼Œè‡ªç”±å‘æŒ¥å³å¯ã€‚ç›®çš„æ˜¯å¸®åŠ©è¦†å†™çš„`process()`æ–¹æ³•å®Œæ•´åœ°å®ç°è‡ªå·±æƒ³è¦çš„æ¨¡å‹é¢„æµ‹åŠŸèƒ½ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ`process()`æ–¹æ³•è¿”å›çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸º`response_data`å’Œ`status_code`ï¼Œå³"è¿”å›å€¼"ä¸"çŠ¶æ€ç "ã€‚æ­£å¸¸è¯·æ±‚ä¸­ï¼Œ"çŠ¶æ€ç "å¯è¿”å›0æˆ–200ã€‚

ä¸‹é¢è´´å‡ºï¼Œæœ¬æ•™ç¨‹ä»»åŠ¡ï¼ˆåŸºäºESIMçš„æ–‡æœ¬ç›¸ä¼¼åº¦æ¨¡å‹é¢„æµ‹ï¼‰çš„`app.py`å¸®åŠ©å¤§å®¶ç†è§£ï¼š

```python
# -*- coding: utf-8 -*-
import allspark
from models.model_config import ESIMConfig
from models.model import ESIM
from utils.load_data import char_index
import tensorflow as tf


class MyProcessor(allspark.BaseProcessor):
    """ MyProcessor is a example
        you can send mesage like this to predict
        curl -v http://127.0.0.1:8080/api/predict/service_name -d '2 105'
    """

    def initialize(self):
        """ load module, executed once at the start of the service
         do service intialization and load models in this function.
        """
        self.model_config = ESIMConfig()
        self.model = ESIM(self.model_config).get_model()
        self.model.load_weights('saved_models/esim_LCQMC_32_LSTM_0715_1036.h5')
        self.model._make_predict_function()
        global graph
        graph = tf.get_default_graph()

    def pre_proccess(self, data):
        """ data format pre process
        """
        x, y = data.split(b' ')
        x, y = char_index([str(x, encoding="utf-8")], [str(y, encoding="utf-8")])
        return x, y

    def process(self, data):
        """ process the request data
        """
        x, y = self.pre_proccess(data)
        global graph
        with graph.as_default():
            y_pred = self.model.predict([x, y]).item()
        return float(y_pred), 0


if __name__ == '__main__':
    # parameter worker_threads indicates concurrency of processing
    runner = MyProcessor(worker_threads=10)
    runner.run()

```

##### Step 3: æœ¬åœ°æµ‹è¯•æœåŠ¡

æš‚æœ‰BUGï¼Œå¯è·³è¿‡ã€‚

å¼€å¯æœåŠ¡ï¼š

```shell
./ENV/bin/python app.py
```

é‡æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼š

```shell
curl http://127.0.0.1:8080/test  -d 'ä»Šå¤©å¤©æ°”ä¸é”™ ä»Šå¤©å¤©æ°”ä¸å¥½'
```

##### Step 4: çº¿ä¸ŠæœåŠ¡å‘å¸ƒ

çº¿ä¸ŠæœåŠ¡å‘å¸ƒï¼Œå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼šæ‰“åŒ…ä¸Šä¼ ã€éƒ¨ç½²æœåŠ¡ã€‚

æ‰“åŒ…ä¸Šä¼ ï¼š

```
cd ..
eascmd64 pysdk pack -u ./pai-eas-tutorial/
```

![image-20190821145843271](assets/image-20190821145843271.png)

å¾…ä¸Šä¼ å®Œæ¯•ï¼Œè®°ä¸‹`oss target path`ï¼Œç”¨äºä¿®æ”¹`app.json`ç”¨äºæœåŠ¡éƒ¨ç½²ã€‚

éƒ¨ç½²æœåŠ¡ï¼Œå…¶å®å°±æ˜¯ä¿®æ”¹`app.json`+åˆ›å»ºæœåŠ¡ï¼ŒåŸå§‹`app.json`æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```shell
{
  "name": "pysdk_demo",
  "processor_entry": "./app.py",
  "processor_type": "python",
  "processor_path": "oss://path/to/processor",
  "metadata": {
    "region": "cn-beijing",
    "instance": 1,
     "memory": 2000,
     "resource": "",
     "cpu": 1
    }
}
```

ä¿®æ”¹å¦‚ä¸‹ï¼š

```shell
{
  "name": "pai_eas_tutorial_04",
  "processor_entry": "./app.py",
  "processor_type": "python",
  "processor_path": "oss://path/to/processor",
  "metadata": {
    "region": "cn-hangzhou",
    "instance": 1,
    "memory": 2000,
    "rpc.keepalive": 10000,
    "resource": "resource_id",
    "cpu": 1
  }
}
```

å…·ä½“å­—æ®µæ„ä¹‰åŠå…¶ä»–åŠŸèƒ½å­—æ®µæ·»åŠ è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://help.aliyun.com/document_detail/111031.html?spm=a2c4g.11186623.6.610.75185ad1xEK253)ã€‚

åˆ›å»ºæœåŠ¡ï¼š

```shell
eascmd64 create app.json
```

![image-20190821151043564](assets/image-20190821151043564.png)

å›¾ä¸­çš„Intranet Endpointï¼ŒTokenéœ€è¦è®°å½•ä¸‹æ¥ï¼Œç”¨äºæœåŠ¡è°ƒç”¨ã€‚

##### Step 5: æœåŠ¡è°ƒç”¨

æœ¬æ•™ç¨‹é¦–å…ˆç»™å‡ºä½¿ç”¨`curl`è¿›è¡ŒæœåŠ¡è°ƒç”¨çš„ç®€å•ç¤ºä¾‹ï¼Œæœªæ¥å°†ç»™å‡ºå¤šè¯­è¨€æœåŠ¡è°ƒç”¨æ¨¡ç‰ˆï¼š

```shell
curl http://pai-eas-vpc.cn-hangzhou.aliyuncs.com/api/predict/pai_eas_tutorial_04 -H 'Authorization: Authorization_id' -d 'æ²¡æœ‰ä¹° æ²¡æœ‰ä¹°'
```

![image-20190821151533490](assets/image-20190821151533490.png)

ç›®å‰ä»…æ”¯æŒé˜¿é‡Œäº‘æœºå™¨å†…éƒ¨è°ƒç”¨ã€‚ğŸ¥´